!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.NicommentJS=e():t.NicommentJS=e()}(this,(function(){return function(t){var e={};function i(s){if(e[s])return e[s].exports;var h=e[s]={i:s,l:!1,exports:{}};return t[s].call(h.exports,h,h.exports,i),h.l=!0,h.exports}return i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var h in t)i.d(s,h,function(e){return t[e]}.bind(null,h));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";i.r(e),i.d(e,"default",(function(){return v}));var s=60,h=3,n=1.2,a=8,o=11,r=16,l={smal:38,big:16,medium:25},c="base",m="MS PGothic",f=1;const d=new class{splitter(t,e=","){return t?t.split(e):[]}padding(t,e=2,i="0"){if(t<10**e){const s=t.toString();let h=s;for(let t=0;t<e-s.length;t++)h=i+h;return h}return t.toString()}createNestedArray(t){const e=[];for(let i=0;i<t;i++)e.push([]);return e}createArray(t){const e=[];return e.length=t,e}calcVPOS(t){const e=Math.floor(t/100);return{ms:{min:Math.floor(e/60),sec:Math.floor(e%60)},sec:e}}};class u{constructor(t){this.life=0,this.delta=0,this.left=0,this.top=0,this.reveal=0,this.touch=0,this.fixed=!1,this.type=t.option.mode,this.customAttr=t.option.customAttr,this.originalText=t.text,this.text=this._formatComment(t.text,this.type),this.textForRender=this._formatRenderComment(this.text),this.textLength=Math.max(...this.text.map(t=>t.length)),this.maxLengthIndex=this.text.map(t=>t.length).indexOf(this.textLength),this.commentNumber=t.commentNumber,this.color=t.option.color,this.borderColor=t.option.borderColor,this.lines=this._getLines(t.option.commentSize,t.lines),this.selfLines=this.text.length,this.ctx=t.ctx,this.fontName=t.option.fontName,this.opacity=t.option.opacity,this.full=t.option.full,this.canvasSize=t.canvasSize,this.canvasWidthFlash=t.canvasWidthFlash,this.text.length>=this.lines&&(this.fixed=!0),this.vpos=t.option.vpos,this.duration=t.option.duration||h,this.fontSizeString=t.option.commentSize,[this.fontSize,this.width,this.offsetY]=this._getFont(this.text[this.maxLengthIndex],this.canvasSize,this.canvasWidthFlash,t.option.commentSize,t.fontSize,t.fixedFontSize,this.type,t.option.lineheight),this.fontSizeString=t.option.commentSize,this.overallSize=this.fontSize*this.selfLines,this.alive=!0,this.onDisposed=t.onDisposed,this._set()}getProp(t){return this.customAttr.get(t)}tick(t){t>=this.vpos+200*this.duration?this.alive=!1:(this.life--,"naka"===this.type&&(this.left-=this.delta,this.reveal--,this.touch--),this.life<0&&this.kill())}kill(){this.alive=!1,this.onDisposed()}_set(){switch(this.life=0,this.left=0,this.top=0,this.delta=0,this.reveal=0,this.touch=0,this.type){case"naka":this._setNaka();break;case"shita":case"ue":this._setShitaUe()}}_setNaka(){this.life=s*this.duration,this.left=this.canvasSize.width,this.delta=(this.canvasSize.width+this.width)/this.life,this.reveal=this.width/this.delta,this.touch=this.canvasSize.width/this.delta}_setShitaUe(){this.life=s*this.duration,this.fixed?this.left=(this.canvasSize.width-this.width)/2:this.left=this.canvasSize.width/2}_getFont(t,e,i,s,h,n,a,o){let r=this._getSize(s,h),l=r;r*this.selfLines>e.height/3&&(l=this._getSize(s,n)),this.ctx.font=l+'px "Yu Gothic"';let c=this.ctx.measureText(t).width;const m=c>this.canvasSize.width&&"naka"!==a;m&&!this.full?(l=this._modSize(r,c,this.canvasWidthFlash),this.ctx.font=l+'px "Yu Gothic"',c=this.ctx.measureText(t).width):m&&this.full&&(l=this._modSize(r,c,this.canvasSize.width),this.ctx.font=l+'px "Yu Gothic"',c=this.ctx.measureText(t).width);return[l,c,"shita"===a?l*(o-1)*-1:l*(o-1)]}_modSize(t,e,i){return t*i/e}_getSize(t,e){switch(t){case"big":return e.big;case"small":return e.small;default:return e.medium}}_getLines(t,e){switch(t){case"big":return e.big;case"medium":return e.medium;case"small":return e.small}}_formatComment(t,e){let i=d.splitter(t,"\n");return i=this._deleteBlank(i),i=this._deleteFirstAndlastBlank(i),i=this._sortByType(i,e),i}_formatRenderComment(t){let e=[...t];return e=this._deleteBlankLineFromEnd(t),e}_deleteBlank(t){let e=0;const i=[];for(const s of t){!s?e++:e=0,e<3&&i.push(s)}return i}_deleteFirstAndlastBlank(t){const e=[...t];for(const i of t){if(i)break;e.shift()}const i=[...e].reverse();for(const t of i){if(t)break;e.pop()}return e}_sortByType(t,e){return"shita"===e?t.reverse():t}_deleteBlankLineFromEnd(t){const e=[...t],i=[...t].reverse();for(const t of i){if(!(/^\s+$/.test(t)||0===t.length))break;e.pop()}return 955601===this.customAttr.get("commentNumber")&&console.log(e),e}}class p{constructor(t){this.height=t.height,this.width=t.width}}class S{constructor(t,e,i,s,h,n,a){this.onDisaposed=()=>{},this.ctx=t,this.canvasSize=e,this.canvasWidthFlash=e.height/3*4,this.lineHeight=a,this.lines=i,this.fonrSize=s,this.fixedFonrSize=h,this.duration=n,this.comments=[],this.maxlines=i.small,this.naka=new g(i.small,e),this.shita=[],this.ue=[]}add(t,e,i,s="naka",h="medium",n,a){if(this.comments.length>40)return;const o={mode:s,color:i.get("color")||"#fff",borderColor:i.get("bcolor")||"#000",duration:this.duration,customAttr:i,commentSize:h,lineheight:this.lineHeight,vpos:a,fontName:i.get("fontName"),opacity:i.get("opacity"),full:i.get("full")},r={text:t,ctx:this.ctx,canvasSize:this.canvasSize,canvasWidthFlash:this.canvasWidthFlash,fontSize:this.fonrSize,fixedFontSize:this.fixedFonrSize,lines:this.lines,option:o,commentNumber:e,onDisposed:n.onDispased},l=new u(r);switch(l.type){case"naka":this.naka.add(l);break;case"shita":this._appendShita(l);break;case"ue":this._appendUe(l)}}tick(t,e,i){const s=e||0,h=!1!==i;this.comments.length&&this.comments.forEach(t=>{h&&this._render(t),t.tick(s)}),h&&this.naka.getList().forEach(t=>{this._render(t)}),this.naka.tick(s),this._clean()}_render(t){switch(this.ctx.textBaseline="top",!0){case"naka"===t.type||t.fixed:this.ctx.textAlign="left";break;default:this.ctx.textAlign="center"}this.ctx.fillStyle=""+t.color,this.ctx.shadowColor=t.borderColor,this.ctx.shadowOffsetX=1.5,this.ctx.shadowOffsetY=1.5,this.ctx.globalAlpha=t.opacity,this.ctx.font=`bold ${t.fontSize}px "${t.fontName}"`;const e=("shita"===t.type?-1:1)*t.fontSize;for(let i=0;i<t.textForRender.length;i++)this.ctx.fillText(t.textForRender[i],t.left,t.top+t.offsetY+e*i)}clear(t){switch(t){case void 0:this.comments.forEach(t=>t.kill()),this.comments=[],this.naka=new g(this.lines.small,this.canvasSize),this.ue=[],this.shita=[];break;case"first":this.comments.length&&this.comments[0].kill();break;case"last":this.comments.length&&this.comments[this.comments.length-1].kill()}}_clean(){this.comments=this.comments.filter(t=>t.alive),this.naka.clean()}_appendShita(t){let e=this.canvasSize.height;for(let i=0;i<40;i++){switch(this.shita[i]&&this.shita[i].alive&&!t.fixed&&(e-=this.shita[i].overallSize),!0){case 0===this.shita.length:case this.shita.length<=i:case!this.shita[i].alive:case t.fixed:case e-t.overallSize+t.offsetY<0:break;default:continue}t.fixed?t.top=this.canvasSize.height-t.fontSize:e-t.overallSize<0?t.top=Math.random()*(this.canvasSize.height-t.overallSize+t.offsetY):t.top=e-t.overallSize,this.shita[i]=t,this.comments.push(t);break}}_appendUe(t){let e=0;for(let i=0;i<40;i++){switch(this.ue[i]&&this.ue[i].alive&&!t.fixed&&(e+=this.ue[i].overallSize),!0){case 0===this.ue.length:case this.ue.length<=i:case!this.ue[i].alive:case t.fixed:case e+t.overallSize+t.offsetY>this.canvasSize.height:break;default:continue}t.fixed?t.top=0:e+t.overallSize+t.offsetY>this.canvasSize.height?t.top=Math.random()*(this.canvasSize.height-t.overallSize):t.top=e,this.ue[i]=t,this.comments.push(t);break}}get(t,e){const i=this.naka.get(t,e);return void 0!==i?i:this.comments.find(i=>{const s=i.width/2,h=t>i.left-s&&t<i.left+s,n=e>i.top&&e<i.top+i.overallSize;if(h&&n)return!0})}}class g{constructor(t,e){this.comments=[],this.lastCommentStream=[],this.allines=t,this.canvasSize=e}add(t){let e=0;for(let i=0;i<this.allines;i++){const s=this.lastCommentStream[i];switch(!0){case void 0===s:case t.fixed:case s.reveal<0&&s.life<t.touch:case e+t.overallSize>this.canvasSize.height:break;default:e+=s.overallSize;continue}t.fixed?t.top=0:e+t.overallSize>this.canvasSize.height?t.top=Math.random()*(this.canvasSize.height-t.overallSize):t.top=e,this.comments.push(t),this.lastCommentStream[i]=t;break}}clean(){this.comments=this.comments.filter(t=>t.alive)}tick(t){this.comments.forEach(e=>{e.tick(t)})}getList(){return this.comments}get(t,e){return this.comments.find(i=>{const s=t>i.left&&t<i.left+i.width,h=e>i.top&&e<i.top+i.overallSize;if(s&&h)return!0})}}class v{constructor(t,e,i,s){this.checkArgs(t,e,i),this.ctx=this._getContext(t,e,i),this.canvasSize=new p({height:i,width:e}),this.meta=new _,this.duration=s&&s.duration?s.duration:h,this.mainLayerName=s&&s.layerName?s.layerName:c,this.lineHeight=s&&s.lineheght?s.lineheght:n,this.lines={big:s&&s.bigLines?s.bigLines:a,medium:s&&s.mediumLines?s.mediumLines:o,small:s&&s.smallLines?s.smallLines:r},this.fixedLines={big:l.big,medium:l.medium,small:l.smal},this.fonrSize=this._getFontSize(i,this.lines),this.fixedFonrSize=this._getFontSize(i,this.fixedLines),this.mainLayerName=s&&s.layerName?s.layerName:c,this.layers=new Map,this.addLayer(this.mainLayerName),this.total=0,this.run=!0,this.isPlay=!0,this.autoTickDisabled=!!s&&(!!s.autoTickDisabled&&s.autoTickDisabled),this.autoTickDisabled||this.tick()}checkArgs(t,e,i){if(!t)throw new Error(x.__INIT__.ARGUMENTS.NOT_EXIST.ID);if(!e)throw new Error(x.__INIT__.ARGUMENTS.NOT_EXIST.WIDTH);if(!i)throw new Error(x.__INIT__.ARGUMENTS.NOT_EXIST.HEIGHT);if("number"!=typeof e)throw new Error(x.__INIT__.ARGUMENTS.NaN.WIDTH(e));if("number"!=typeof i)throw new Error(x.__INIT__.ARGUMENTS.NaN.HEIGHT(i))}send(t,e){let i=new Map;const s=e&&e.layer?e.layer:this.mainLayerName,h=e&&e.type?e.type:"naka",n=e&&e.size?e.size:"medium",a=e&&e.color?e.color:"#fff",o=this.getBcolor(a),r=e&&e.vpos?e.vpos:0,l=e&&e.fontName?e.fontName:m,c=e&&e.opacity?e.opacity:f,d=!!e&&(!!e.full&&e.full),u=e&&e.onDisposed?e.onDisposed:()=>{};this.total++,void 0!==e&&void 0!==e.customAttr&&(i=this._getAttr(e.customAttr)),i.set("color",a),i.set("bcolor",o),i.set("fontName",l),i.set("opacity",c),i.set("full",d);const p=this.layers.get(s);if(void 0===p)throw new Error(x.LAYER.LAYER_DOES_NOT_EXIST(s));p.add(t,this.total,i,h,n,{onDispased:u},r)}pause(){this.isPlay=!1}play(){this.isPlay=!0}clear(t){if(t){const e=this.layers.get(t);if(void 0===e)throw new Error(x.LAYER.LAYER_DOES_NOT_EXIST(t));e.clear()}else this.layers.forEach(t=>{t.clear()})}dispose(){this.run=!1,this.isPlay=!1,this.layers.forEach(t=>{t.clear()}),this.ctx.clearRect(0,0,this.canvasSize.width,this.canvasSize.height),this.layers.clear()}_getAttr(t){const e=new Map;for(const[i,s]of Object.entries(t))e.set(i,s);return e}_getFontSize(t,e){return{big:t/e.big,medium:t/e.medium,small:t/e.small}}_getContext(t,e,i){const s=document.getElementById(t);if(s){s.height=i,s.width=e,s.style.width=e+"px",s.style.height=i+"px";const t=s.getContext("2d");if(null!==t)return t;throw new Error}throw new Error(x.__INIT__.ELEMENT.NOT_EXIST(t))}tick(t,e){this.isPlay&&(void 0!==e&&!0!==e||this.ctx.clearRect(0,0,this.canvasSize.width,this.canvasSize.height),this.layers.forEach(i=>{i.tick(this.meta.getCount(),t,e)}),this.meta.loop()),this.run&&!this.autoTickDisabled&&requestAnimationFrame(()=>{this.tick(t)})}getBcolor(t){switch(t){case"black":case"#000":case"#000000":return"#fff";default:return"#000"}}get(t,e){let i=void 0;return this.layers.forEach(s=>{if(i=s.get(t,e),i)return!1}),i}addLayer(t){if(this.layers.has(t))throw new Error(x.LAYER.DUPLICATION(t));this.layers.set(t,new S(this.ctx,this.canvasSize,this.lines,this.fonrSize,this.fixedFonrSize,this.duration,this.lineHeight))}removeLayer(t){if(this.layers.has(t))throw new Error(x.LAYER.DUPLICATION(t));this.layers.delete(t)}}class _{constructor(){this.count=0}loop(){this.count++}getCount(){return this.count}}const x={__INIT__:{ARGUMENTS:{NOT_EXIST:{HEIGHT:'[ERR]argument "height" must be specified.',WIDTH:'[ERR]argument "width" must be specified.',ID:'[ERR]argument "id" must be specified.'},NaN:{HEIGHT:t=>`[ERR]${t} is not a number. "height" mus be a number.`,WIDTH:t=>`[ERR]${t} is not a number. "width" mus be a number.`}},ELEMENT:{NOT_EXIST:t=>`[ERR]Canvas Element which id is "${t}" was not found.`,NOT_A_CANVAS_ELEMENT:t=>`[ERR]Element which id is "${t}" is not a canvasHTML5 Element.`}},SEND:{},LAYER:{DUPLICATION:t=>`[ERR]The layer name ${t} already exists.`,LAYER_DOES_NOT_EXIST:t=>`[ERR]A layer name is ${t} does not exist.`}}}]).default}));